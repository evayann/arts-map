import { Injectable } from '@angular/core';
import { overpass } from 'overpass-ts';
import { OsmGeometry, OsmRequestParameters } from './models/OsmFeature';

@Injectable({
  providedIn: 'root',
})
export class OsmFeaturesService {
  constructor() {}

  getGeometries(): OsmGeometry[] {
    return ['way', 'node', 'relation'];
  }

  // "#mw-content-text > div.mw-parser-output > table:nth-child(18) > tbody"
  // Array.from(al.children).filter(el => el.children.length > 1).map(el => `'${el.children[1].children[0].innerText}'`).join(",")

  getFeatures(): Record<string, string[]> {
    return {
      aerialway: [
        'cable_car',
        'gondola',
        'mixed_lift',
        'drag_lift',
        'platter',
        'rope_low',
        'magic_carpet',
        'zip_line',
        'goods',
        'pylon',
        'station',
      ],
      aeroway: [
        'aerodrome',
        'aircraft_crossing',
        'apron',
        'gate',
        'hangar',
        'helipad',
        'heliport',
        'navigationaid',
        'runway',
        'spaceport',
        'taxiway',
        'terminal',
        'windsock',
      ],
      amenity: [
        'bar',
        'biergarten',
        'cafe',
        'fast_food',
        'food_court',
        'ice_cream',
        'pub',
        'restaurant',
        'college',
        'driving_school',
        'kindergarten',
        'language_school',
        'library',
        'toy_library',
        'music_school',
        'school',
        'university',
        'bicycle_parking',
        'bicycle_repair_station',
        'bicycle_rental',
        'boat_rental',
        'boat_sharing',
        'bus_station',
        'car_rental',
        'car_sharing',
        'car_wash',
        'vehicle_inspection',
        'charging_station',
        'ferry_terminal',
        'fuel',
        'grit_bin',
        'motorcycle_parking',
        'parking',
        'parking_entrance',
        'parking_space',
        'taxi',
        'atm',
        'bank',
        'bureau_de_change',
        'baby_hatch',
        'clinic',
        'dentist',
        'doctors',
        'hospital',
        'nursing_home',
        'pharmacy',
        'social_facility',
        'veterinary',
        'arts_centre',
        'brothel',
        'casino',
        'cinema',
        'community_centre',
        'conference_centre',
        'events_venue',
        'fountain',
        'gambling',
        'love_hotel',
        'nightclub',
        'planetarium',
        'public_bookcase',
        'social_centre',
        'stripclub',
        'studio',
        'swingerclub',
        'theatre',
        'courthouse',
        'fire_station',
        'police',
        'post_box',
        'post_depot',
        'post_office',
        'prison',
        'ranger_station',
        'townhall',
        'bbq',
        'bench',
        'dog_toilet',
        'drinking_water',
        'give_box',
        'parcel_locker',
        'shelter',
        'shower',
        'telephone',
        'toilets',
        'water_point',
        'watering_place',
        'sanitary_dump_station',
        'recycling',
        'waste_basket',
        'waste_disposal',
        'waste_transfer_station',
        'animal_boarding',
        'animal_breeding',
        'animal_shelter',
        'baking_oven',
        'childcare',
        'clock',
        'crematorium',
        'dive_centre',
        'funeral_hall',
        'grave_yard',
        'hunting_stand',
        'internet_cafe',
        'kitchen',
        'kneipp_water_cure',
        'lounger',
        'marketplace',
        'monastery',
        'photo_booth',
        'place_of_mourning',
        'place_of_worship',
        'public_bath',
        'public_building',
        'refugee_site',
        'vending_machine',
        'user defined',
      ],
      barrier: [
        'cable_barrier',
        'city_wall',
        'ditch',
        'fence',
        'guard_rail',
        'handrail',
        'hedge',
        'kerb',
        'retaining_wall',
        'wall',
        'block',
        'bollard',
        'border_control',
        'bump_gate',
        'bus_trap',
        'cattle_grid',
        'chain',
        'cycle_barrier',
        'debris',
        'entrance',
        'full-height_turnstile',
        'gate',
        'hampshire_gate',
        'height_restrictor',
        'horse_stile',
        'jersey_barrier',
        'kissing_gate',
        'lift_gate',
        'log',
        'motorcycle_barrier',
        'rope',
        'sally_port',
        'spikes',
        'stile',
        'sump_buster',
        'swing_gate',
        'toll_booth',
        'turnstile',
        'yes',
      ],
      boundary: [
        'aboriginal_lands',
        'administrative',
        'border_zone',
        'forest',
        'forest_compartment',
        'hazard',
        'maritime',
        'marker',
        'national_park',
        'place',
        'political',
        'postal_code',
        'protected_area',
        'special_economic_zone',
        'disputed',
        'user defined',
      ],
      building: [
        'apartments',
        'barracks',
        'bungalow',
        'cabin',
        'detached',
        'dormitory',
        'farm',
        'ger',
        'hotel',
        'house',
        'houseboat',
        'residential',
        'semidetached_house',
        'static_caravan',
        'terrace',
        'commercial',
        'industrial',
        'kiosk',
        'office',
        'retail',
        'supermarket',
        'warehouse',
        'cathedral',
        'chapel',
        'church',
        'kingdom_hall',
        'monastery',
        'mosque',
        'presbytery',
        'religious',
        'shrine',
        'synagogue',
        'temple',
        'bakehouse',
        'civic',
        'college',
        'fire_station',
        'government',
        'hospital',
        'kindergarten',
        'public',
        'school',
        'toilets',
        'train_station',
        'transportation',
        'university',
        'barn',
        'conservatory',
        'cowshed',
        'farm_auxiliary',
        'greenhouse',
        'slurry_tank',
        'stable',
        'sty',
        'grandstand',
        'pavilion',
        'riding_hall',
        'sports_hall',
        'stadium',
        'hangar',
        'hut',
        'shed',
        'carport',
        'garage',
        'garages',
        'parking',
        'digester',
        'service',
        'transformer_tower',
        'water_tower',
        'storage_tank',
        'silo',
        'beach_hut',
        'bunker',
        'bridge',
        'castle',
        'construction',
        'container',
        'gatehouse',
        'military',
        'roof',
        'ruins',
        'stilt_house',
        'tent',
        'tree_house',
        'yes',
      ],
      craft: [
        'agricultural_engines',
        'atelier',
        'bakery',
        'basket_maker',
        'beekeeper',
        'blacksmith',
        'boatbuilder',
        'bookbinder',
        'brewery',
        'builder',
        'cabinet_maker',
        'car_painter',
        'carpenter',
        'carpet_layer',
        'caterer',
        'chimney_sweeper',
        'cleaning',
        'clockmaker',
        'confectionery',
        'cooper',
        'dental_technician',
        'distillery',
        'door_construction',
        'dressmaker',
        'electronics_repair',
        'embroiderer',
        'electrician',
        'engraver',
        'floorer',
        'fruit_press',
        'gardener',
        'glaziery',
        'goldsmith',
        'grinding_mill',
        'handicraft',
        'hvac',
        'insulation',
        'interior_decorator',
        'interior_work',
        'jeweller',
        'joiner',
        'key_cutter',
        'locksmith',
        'metal_construction',
        'mint',
        'musical_instrument',
        'oil_mill',
        'optician',
        'organ_builder',
        'painter',
        'parquet_layer',
        'paver',
        'photographer',
        'photographic_laboratory',
        'piano_tuner',
        'plasterer',
        'plumber',
        'pottery',
        'printer',
        'printmaker',
        'rigger',
        'roofer',
        'saddler',
        'sailmaker',
        'sawmill',
        'scaffolder',
        'sculptor',
        'shoemaker',
        'signmaker',
        'stand_builder',
        'stonemason',
        'stove_fitter',
        'sun_protection',
        'tailor',
        'tiler',
        'tinsmith',
        'toolmaker',
        'turner',
        'upholsterer',
        'watchmaker',
        'water_well_drilling',
        'window_construction',
        'winery',
      ],
      emergency: [
        // Medical
        'ambulance_station',
        'defibrillator',
        'landing_site',
        'emergency_ward_entrance',
        // Firefighter
        'dry_riser_inlet',
        'fire_alarm_box',
        'fire_extinguisher',
        'fire_hose',
        'fire_hydrant',
        'water_tank',
        'suction_point',
        //LifeGuards
        'lifeguard',
        'life_ring',
        // Others
        'assembly_point',
        'phone',
        'siren',
        'drinking_water',
      ],
      geological: [
        'moraine',
        'outcrop',
        'palaeontological_site',
        'volcanic_caldera_rim',
        'volcanic_vent',
        'volcanic_lava_field',
        'columnar_jointing',
      ],
      highway: [
        'motorway',
        'trunk',
        'primary',
        'secondary',
        'tertiary',
        'unclassified',
        'residential',
        'motorway_link',
        'primary_link',
        'secondary_link',
        'tertiary_link',
        'living_street',
        'service',
        'pedestrian',
        'track',
        'bus_guideway',
        'escape',
        'raceway',
        'road',
        'busway',
        'footway',
        'bridleway',
        'steps',
        'corridor',
        'path',
        'sidewalk',
        'crossing',
        'undefined',
        'cycleway',
        'lane',
        'opposite',
        'opposite_lane',
        'track',
        'opposite_track',
        'share_busway',
        'opposite_share_busway',
        'shared_lane',
        'lane',
        'proposed',
        'construction',
        'bus_stop',
        'crossing',
        'elevator',
        'emergency_bay',
        'emergency_access_point',
        'give_way',
        'phone',
        'milestone',
        'mini_roundabout',
        'motorway_junction',
        'passing_place',
        'platform',
        'rest_area',
        'services',
        'speed_camera',
        'stop',
        'street_lamp',
        'toll_gantry',
        'traffic_mirror',
        'traffic_signals',
        'trailhead',
        'turning_circle',
        'turning_loop',
      ],
    };
  }

  request({
    features,
    bbox,
    timeout,
  }: OsmRequestParameters): Promise<Response> {
    const featureToRequest = (): string =>
      features
        .map((f) => {
          const geometry: string = f.geometry == 'all' ? 'nwr' : f.geometry;
          const element: string = f.value == '*' ? f.key : `${f.key}"="${f.value}`;
          return `${geometry}["${element}"](${bbox});`;
        })
        .join('\n');

    const request = `
        [out:json][timeout:${timeout || 50}];
        (
        ${featureToRequest()}
        );
        out body;
        >;
        out skel qt;
    `;

    console.log(`DEBUG : request=${request}`);

    return overpass(request);
  }
}
